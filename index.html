<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#0f1220" />
<title>PASAPALABRA ‚Äî V24.5 (selector 1‚Äì10 semillado)</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800;900&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0b0f24;--panel:#141a3d;--ink:#eef2fb;--muted:#9aa3b2;--brand:#7c5cff;--ok:#1ec28b;--bad:#ff5d6c;--waiting:#25306a;--accent:#ffd166;--ring1:#1b214f;--ring2:#0a0f2e;--dot:36px}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;color:var(--ink);font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Helvetica Neue",Arial,sans-serif;
       background:radial-gradient(1200px 800px at 10% 10%, rgba(124,92,255,.22), transparent 60%),
                  radial-gradient(900px 600px at 90% 20%, rgba(30,194,139,.18), transparent 60%),
                  linear-gradient(180deg,#0a0d22,#10163a 55%,#0b0f2a)}
  .wrap{max-width:1200px;margin-inline:auto;padding:14px}
  .mast{display:flex;align-items:center;justify-content:space-between;gap:10px;background:linear-gradient(90deg,#111851,#1a2b6e 60%,#111851);
        border:1px solid #243189;border-radius:18px;padding:14px 16px;margin-bottom:10px;box-shadow:0 8px 22px rgba(0,0,0,.25),inset 0 0 24px rgba(255,255,255,.06)}
  .mast h1{margin:0;font-size:26px;letter-spacing:.1em;font-weight:900;text-transform:uppercase;text-shadow:0 2px 0 rgba(0,0,0,.25),0 0 24px rgba(124,92,255,.35)}
  .badge{background:var(--waiting);padding:6px 10px;border-radius:999px;font-size:12px}
  .btn{border:0;padding:12px 14px;border-radius:14px;cursor:pointer;font-weight:800;font-size:16px}
  .btn-ghost{background:#101640;color:var(--ink);border:1px solid #2a357a}
  .btn-primary{background:var(--brand);color:#fff}
  .btn-danger{background:var(--bad);color:#fff}
  .btn-ok{background:var(--ok);color:#002017}
  .btn-write.active{background:#ffd166;color:#241a00}
  .games{display:flex;gap:6px;overflow:auto;padding:8px 2px 6px 2px;margin-bottom:6px}
  .game-btn{min-width:42px;height:38px;border-radius:12px;border:1px solid #2a357a;background:#0f1542;color:#cdd3ea;cursor:pointer;font-weight:900}
  .game-btn.active{background:var(--brand);color:#fff;border-color:#7c5cff}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .panel{background:var(--panel);border:1px solid #1e2660;border-radius:16px;padding:12px;box-shadow:0 8px 22px rgba(0,0,0,.25)}
  .panel h2{margin:0 0 6px 0;font-size:15px}
  .timer{font-variant-numeric:tabular-nums;font-weight:900;font-size:36px;letter-spacing:1px}
  .stats{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap}
  .stat{background:#0f1542;border:1px solid #28327a;padding:6px 10px;border-radius:10px;font-size:13px}
  .stat strong{font-size:15px}
  .rosco-wrap{position:relative;aspect-ratio:1/1;max-width:360px;margin:18px auto;border-radius:50%;
    background:radial-gradient(circle at 50% 50%, #12194a 57%, transparent 58%), radial-gradient(circle at 50% 50%, var(--ring1) 64%, var(--ring2) 66%, transparent 67%);
    box-shadow:0 0 0 2px #202a70 inset,0 0 38px rgba(124,92,255,.22) inset;overflow:hidden}
  .rosco-wrap::before{content:"";position:absolute;inset:-10%;border-radius:50%;
    background:conic-gradient(from 0deg, rgba(255,255,255,.06), rgba(255,255,255,0), rgba(255,255,255,.06));
    animation:spin 10s linear infinite;pointer-events:none}
  @keyframes spin{to{transform:rotate(360deg)}}
  .dot{position:absolute;width:var(--dot);height:var(--dot);border-radius:50%;display:grid;place-items:center;font-weight:900;color:#0b0f2a;background:#fff;
       border:2px solid rgba(255,255,255,.15);transform:translate(-50%,-50%);text-shadow:0 1px 0 rgba(255,255,255,.25)}
  .dot::after{content:attr(data-letter)}
  .dot.active{outline:3px solid var(--accent);outline-offset:2px;filter:brightness(1.05)}
  .dot.ok{background:linear-gradient(#2ef0b1,#13bd86);color:#042821;border-color:#35e6aa}
  .dot.bad{background:linear-gradient(#ff8a99,#ff5d6c);color:#31070b;border-color:#ff6f7b}
  .center{grid-column:1/-1}
  .prompt{font-size:16px;line-height:1.5}
  .tag{display:inline-block;margin-bottom:8px;background:#0f1542;border:1px solid #29347c;color:#a8b1c6;padding:4px 8px;border-radius:999px;font-size:12px}
  .clue{font-size:18px;margin:6px 0 12px 0;min-height:54px}
  .inputrow{display:flex;gap:8px}
  input[type=text]{flex:1;padding:14px;border-radius:12px;border:1px solid #2a357a;background:#0c1231;color:#eef2fb;font-size:18px;outline:none}
  input[type=text].hold{box-shadow:0 0 0 3px #ffd16655}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .footer{display:flex;justify-content:space-between;gap:10px;margin-top:10px;color:#9aa3b2;font-size:12px}
  .winner{padding:10px 12px;border-radius:12px;background:#0e1330;border:1px solid #2b3378;margin-top:10px}
  .overlay{position:fixed;inset:0;background:rgba(6,10,26,.75);display:none;place-items:center;z-index:60;padding:20px}
  .overlay .box{background:#0c1231;border:1px solid #2b3378;border-radius:16px;padding:18px 20px;text-align:center;max-width:520px}
  .overlay .box h3{margin:0 0 8px 0}
  .count{font-size:72px;font-weight:900;letter-spacing:.05em}
  .fab{position:fixed;right:16px;bottom:16px;width:64px;height:64px;border-radius:50%;border:0;background:var(--brand);color:#fff;font-size:26px;display:grid;place-items:center;box-shadow:0 8px 25px rgba(0,0,0,.35);z-index:55}
  .fab:active{transform:scale(.98)}
  details.help{background:#0e1440;border:1px solid #2a357a;border-radius:16px;padding:8px 12px;margin:10px 0}
  details.help summary{cursor:pointer;font-weight:800}
  details.help p{margin:.35em 0}

  /* Vista ENFOQUE por defecto (rosco grande m√≥vil) */
  body.view-focus{--dot:48px}
  body.view-focus .grid{grid-template-columns:1fr}
  body.view-focus #pA, body.view-focus #pB{display:none}
  body.view-focus.focus-A #pA, body.view-focus.focus-B #pB{display:block}
  body.view-focus .rosco-wrap{max-width:540px}
  /* Vista doble */
  body.view-dual{--dot:34px}

  /* Fallback <dialog> */
  dialog[open]{display:block;position:fixed;inset:20px;max-width:520px;margin:auto;background:#0c1231;border:1px solid #2b3378;border-radius:16px;padding:18px 20px;z-index:65}

  /* Burbujita central de respuesta correcta */
  .center-bubble{
    position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    background:rgba(10,16,48,.9);border:1px solid #3a4699;border-radius:14px;
    padding:10px 12px; text-align:center; max-width:70%; font-size:16px; line-height:1.35;
    box-shadow:0 6px 20px rgba(0,0,0,.35)
  }
  .center-bubble b{color:#ffd166}
</style>
</head>
<body class="view-focus focus-A">
  <div class="wrap">
    <div class="mast">
      <h1>PASAPALABRA</h1>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <span class="badge">V24.5</span>
        <button class="btn btn-ghost" id="btnView">üë§ Enfoque</button>
        <button class="btn btn-ghost" id="btnSettings">‚öôÔ∏è Ajustes</button>
        <button class="btn btn-ghost" id="btnNew">Nuevo rosco</button>
      </div>
    </div>

    <!-- Selector de juegos 1‚Äì10 -->
    <div class="games" id="gamesBar" aria-label="Selector de juego"></div>

    <details class="help">
      <summary>üìñ Instrucciones (toca para ver)</summary>
      <p>‚Ä¢ Mantienes el <strong>turno mientras aciertas</strong>; cambia si <strong>fallas</strong> o dices <strong>pasapalabra</strong>.</p>
      <p>‚Ä¢ Si pasas/fallas, tu siguiente turno sigue por la <strong>siguiente letra</strong>. Tras la Z, se repasan las <em>pendientes</em> en orden.</p>
      <p>‚Ä¢ Vista <strong>üë§ Enfoque</strong> (rosco grande del jugador activo) o <strong>üë• Doble</strong>.</p>
      <p>‚Ä¢ <strong>‚úçÔ∏è Escribir (pausar)</strong> congela tu tiempo al teclear. <strong>Pausar</strong> detiene todo.</p>
      <p>‚Ä¢ **Juegos 1‚Äì10**: cada n√∫mero carga un rosco nuevo reproducible. Cambiar de n√∫mero reinicia la partida.</p>
    </details>

    <section class="grid">
      <div class="panel" id="pA">
        <h2 id="nameA">Jugador A</h2>
        <div class="timer" id="tA">02:25</div>
        <div class="stats">
          <div class="stat">‚úÖ <strong id="aOK">0</strong></div>
          <div class="stat">‚ùå <strong id="aBAD">0</strong></div>
          <div class="stat">‚è≥ <strong id="aPEN">25</strong></div>
        </div>
        <div class="rosco-wrap" id="rA"></div>
      </div>

      <div class="panel" id="pB">
        <h2 id="nameB">Jugador B</h2>
        <div class="timer" id="tB">02:25</div>
        <div class="stats">
          <div class="stat">‚úÖ <strong id="bOK">0</strong></div>
          <div class="stat">‚ùå <strong id="bBAD">0</strong></div>
          <div class="stat">‚è≥ <strong id="bPEN">25</strong></div>
        </div>
        <div class="rosco-wrap" id="rB"></div>
      </div>

      <div class="center panel">
        <div class="prompt">
          <span class="tag" id="turnTag">Turno: Jugador A</span>
          <span class="tag" id="gameTag" style="background:#152064;border-color:#2a3a8a">Juego: 1</span>
          <span class="tag" id="writeTag" style="display:none;background:#3a2a00;border-color:#8a6f1a;color:#ffd166">‚úçÔ∏è Escribiendo ‚Äî tiempo congelado</span>
          <div class="clue" id="clue">Pulsa ‚ÄúEmpezar‚Äù.</div>
        </div>
        <div class="inputrow">
          <input id="answer" type="text" placeholder="Escribe (o di ‚Äòpasapalabra‚Äô)" autocomplete="off" inputmode="latin" />
          <button class="btn btn-primary" id="btnStart">Empezar</button>
          <button class="btn btn-ok" id="btnAnswer" disabled>Responder</button>
          <button class="btn btn-ghost" id="btnPass" disabled>Pasapalabra</button>
        </div>
        <div class="toolbar">
          <button class="btn btn-ghost btn-write" id="btnWrite">‚úçÔ∏è Escribir (pausar)</button>
          <button class="btn btn-danger" id="btnGiveUp" disabled>Marcar fallo</button>
          <button class="btn btn-ghost" id="btnPause">Pausar</button>
          <span id="supportNote" style="color:#9aa3b2;font-size:12px"></span>
        </div>
        <div class="winner" id="result" style="display:none"></div>
        <div class="footer"><span>Desempate por fallos</span></div>
      </div>
    </section>
  </div>

  <!-- Overlays -->
  <div class="overlay" id="ovPause"><div class="box"><h3>Pausa</h3><p>Todo detenido.</p><button class="btn btn-primary" id="btnResume">Reanudar</button></div></div>
  <div class="overlay" id="ovCount"><div class="box"><div class="count" id="countNum">3</div><p>Preparados‚Ä¶</p></div></div>
  <div class="overlay" id="ovBreak"><div class="box"><h3 id="brTitle">Cambio de turno</h3><p id="brText">Respira‚Ä¶</p><button class="btn btn-primary" id="btnContinue">Continuar</button></div></div>

  <button class="fab" id="btnPauseFab" aria-label="Pausar">‚è∏Ô∏è</button>

  <!-- Ajustes -->
  <dialog id="dlg">
    <h3 style="margin:0 0 8px 0">Ajustes</h3>
    <div class="row" style="display:flex;align-items:center;gap:10px;margin:10px 0">
      <label for="rngTime" style="min-width:160px">Segundos por jugador</label>
      <input id="rngTime" type="range" min="95" max="180" step="5" value="145" style="flex:1" />
      <span class="val" id="valTime">145 s</span>
    </div>
    <div class="row" style="display:flex;align-items:center;gap:10px;margin:6px 0">
      <input id="chkTTS" type="checkbox" checked /> <label for="chkTTS">Voz (leer definiciones y cuenta atr√°s)</label>
    </div>
    <div class="row" style="display:flex;align-items:center;gap:10px;margin:6px 0">
      <input id="chkSound" type="checkbox" checked /> <label for="chkSound">Sonidos (acierto/fallo/pasar y pitidos)</label>
    </div>
    <div class="row" style="display:flex;align-items:center;gap:10px;margin:6px 0">
      <label for="nameAInput" style="min-width:160px">Nombre Jugador A</label>
      <input id="nameAInput" type="text" placeholder="Jugador A" style="flex:1;padding:10px;border-radius:10px;border:1px solid #2a357a;background:#0c1231;color:#eef2fb" />
    </div>
    <div class="row" style="display:flex;align-items:center;gap:10px;margin:6px 0">
      <label for="nameBInput" style="min-width:160px">Nombre Jugador B</label>
      <input id="nameBInput" type="text" placeholder="Jugador B" style="flex:1;padding:10px;border-radius:10px;border:1px solid #2a357a;background:#0c1231;color:#eef2fb" />
    </div>
    <div class="row" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
      <button class="btn btn-ghost" id="btnTestVoice">üîä Probar voz</button>
      <button class="btn btn-ghost" id="btnTestBeep">üîî Probar sonido</button>
    </div>
    <div id="ttsStatus" style="margin-top:6px;color:#9aa3b2;font-size:12px"></div>
    <div class="row" style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
      <button class="btn btn-ghost" id="btnCancel">Cerrar</button>
      <button class="btn btn-primary" id="btnApply">Aplicar</button>
    </div>
    <p style="margin-top:8px;font-size:12px;color:#9aa3b2">Consejo: en HTTPS (GitHub Pages) la voz/sonidos van mejor y puedes usar micr√≥fono.</p>
  </dialog>

<script>
(function(){
  /* ===== Polyfills m√≠nimos ===== */
  if(!Array.prototype.findIndex){
    Array.prototype.findIndex=function(cb, thisArg){
      for(var i=0;i<this.length;i++){ if(cb.call(thisArg, this[i], i, this)) return i; }
      return -1;
    };
  }
  function pad2(n){ return (n<10?'0':'')+n; }

  /* ===== Utilidades y estado ===== */
  var LETTERS=["A","B","C","D","E","F","G","H","I","J","L","M","N","√ë","O","P","Q","R","S","T","U","V","X","Y","Z"];
  var state={
    rosco:{A:[],B:[]}, idx:{A:0,B:0}, time:{A:145,B:145},
    active:'A', running:false, finished:false, paused:false, dirty:false,
    fuzzy:true, timer:null, typingHold:false, counting:false, turnBreak:false,
    view:'focus', tts:true, sounds:true, voice:null,
    names:{A: localStorage.getItem('rosco_name_A') || 'Jugador A', B: localStorage.getItem('rosco_name_B') || 'Jugador B'},
    game: parseInt(localStorage.getItem('rosco_game')||'1',10) || 1
  };
  function $(s){ return document.querySelector(s); }
  function norm(s){ return (s||"").toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim(); }
  function tfmt(s){ var m=Math.floor(s/60), ss=Math.floor(s%60); return pad2(m)+':'+pad2(ss); }

  /* ===== RNG con semilla (mulberry32) ===== */
  function mulberry32(a){ return function(){ var t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15, t|1); t^=t+Math.imul(t^t>>>7, t|61); return ((t^t>>>14)>>>0)/4294967296; }; }
  function seedFromGame(game){ // n√∫mero de juego -> semilla 32 bits
    var g=parseInt(game,10)||1; var s=(g*2654435761)>>>0; return s;
  }
  function seededPick(arr, n, rng){
    var c=arr.slice(); // shuffle Fisher-Yates con rng
    for(var i=c.length-1;i>0;i--){ var j=(rng()* (i+1))|0; var t=c[i]; c[i]=c[j]; c[j]=t; }
    return c.slice(0, Math.min(n,c.length));
  }

  /* ===== AudioContext + sonidos + TTS ===== */
  var ACTX=null, audioUnlocked=false;
  function getCtx(){
    try{
      var C=window.AudioContext||window.webkitAudioContext; if(!C) return null;
      if(!ACTX) ACTX=new C();
      if(ACTX.state==='suspended'){ ACTX.resume(); }
      return ACTX;
    }catch(e){ return null; }
  }
  function unlockAudio(){ if(audioUnlocked) return; var ctx=getCtx(); if(!ctx) return;
    try{ var o=ctx.createOscillator(), g=ctx.createGain(); g.gain.value=0; o.connect(g); g.connect(ctx.destination); o.start(0); o.stop(ctx.currentTime+0.01); audioUnlocked=true; }catch(e){} }
  ['touchstart','mousedown'].forEach(function(ev){ document.addEventListener(ev,function(){ unlockAudio(); }, {once:true, passive:true}); });

  function tone(freq, dur, type){
    if(!state.sounds) return; var ctx=getCtx(); if(!ctx) return;
    try{ var o=ctx.createOscillator(), g=ctx.createGain(); o.type=type||'sine'; o.frequency.value=freq||880; g.gain.value=0.0001;
      o.connect(g); g.connect(ctx.destination); var t=ctx.currentTime; g.gain.exponentialRampToValueAtTime(0.2, t+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t+(dur||0.25)); o.start(t); o.stop(t+(dur||0.25)+0.02); }catch(e){}
  }
  var sCorrect=function(){ tone(1046,0.18,'triangle'); };
  var sFail=function(){ tone(196,0.32,'sawtooth'); };
  var sPass=function(){ tone(660,0.18,'square'); };

  function pickVoice(){
    if(!('speechSynthesis' in window)) return;
    var vs=window.speechSynthesis.getVoices();
    var es=vs.filter(function(v){ return v.lang && v.lang.toLowerCase().indexOf('es')===0; });
    state.voice = es.find(function(v){ return /es[-_]es/i.test(v.lang); }) || es[0] || null;
    $('#ttsStatus').textContent = state.voice ? ('Voz: '+(state.voice.name||'es-ES')) : 'No se encontr√≥ voz espa√±ola; usar√© la del sistema.';
  }
  if('speechSynthesis' in window){ window.speechSynthesis.onvoiceschanged = pickVoice; pickVoice(); }
  function speak(txt){
    try{
      if(!state.tts || !('speechSynthesis' in window)) return;
      if(state.paused || state.turnBreak) return;
      var u=new SpeechSynthesisUtterance(txt); u.lang='es-ES'; u.rate=1; u.pitch=1;
      if(state.voice) u.voice=state.voice;
      window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
    }catch(e){}
  }

  /* ===== Banco (demo) ===== */
  var BANK={
    A:[{a:"abstinencia",c:"Privaci√≥n voluntaria de consumir algo."},{a:"anacronismo",c:"Error por situar algo fuera de su √©poca."},{a:"arcano",c:"Secreto o cosa misteriosa."}],
    B:[{a:"barometro",c:"Aparato que mide la presi√≥n atmosf√©rica."},{a:"bitacora",c:"Cuaderno de navegaci√≥n; diario."},{a:"bonanza",c:"Periodo de prosperidad o calma."}],
    C:[{a:"cautela",c:"Prudencia para evitar riesgos."},{a:"catarata",c:"Salto de agua grande; opacidad del cristalino."},{a:"cisma",c:"Divisi√≥n en una organizaci√≥n."}],
    D:[{a:"diligencia",c:"Cuidado y rapidez en ejecutar algo."},{a:"desidia",c:"Descuido o pereza en obligaciones."},{a:"diatriba",c:"Escrito o discurso violento y ofensivo."}],
    E:[{a:"epilogo",c:"Parte final de una obra."},{a:"efimero",c:"De corta duraci√≥n."},{a:"eclectico",c:"Que combina tendencias distintas."}],
    F:[{a:"falaz",c:"Enga√±oso, aparente."},{a:"frugal",c:"Moderado en comida o gasto."},{a:"fertil",c:"Que produce en abundancia."}],
    G:[{a:"glaciar",c:"Masa de hielo en movimiento."},{a:"gravamen",c:"Carga u obligaci√≥n tributaria."},{a:"gregario",c:"Que vive en grupo."}],
    H:[{a:"hecatombe",c:"Suceso tr√°gico con gran destrucci√≥n."},{a:"hibernar",c:"Pasar el invierno en reposo."},{a:"hosco",c:"Ce√±udo, de mal humor."}],
    I:[{a:"ignifugo",c:"Que resiste el fuego."},{a:"inercia",c:"Resistencia a cambiar el movimiento."},{a:"inedito",c:"No publicado."}],
    J:[{a:"jazmin",c:"Planta de flores arom√°ticas."},{a:"jornada",c:"D√≠a de trabajo."},{a:"jocoso",c:"Gracioso, festivo."}],
    L:[{a:"lexico",c:"Conjunto de palabras de una lengua."},{a:"lobrego",c:"Oscuro, t√©trico."},{a:"laconico",c:"Breve, conciso."}],
    M:[{a:"madriguera",c:"Refugio subterr√°neo de animales."},{a:"mitomano",c:"Persona con tendencia patol√≥gica a mentir."},{a:"magnanimo",c:"Generoso; noble de √°nimo."}],
    N:[{a:"nebulosa",c:"Nube interestelar de gas y polvo."},{a:"nadir",c:"Punto opuesto al cenit."},{a:"nemesis",c:"Rival o justa retribuci√≥n."}],
    "√ë":[{a:"arana",c:"Ar√°cnido que teje telas. (contiene √ë)"},{a:"anorar",c:"Echar de menos con intensidad. (contiene √ë)"},{a:"canizo",c:"Enrejado de ca√±as. (contiene √ë)"}],
    O:[{a:"osamenta",c:"Conjunto de huesos."},{a:"osmosis",c:"Paso de solvente por membrana semipermeable."},{a:"oprobio",c:"Deshonra p√∫blica."}],
    P:[{a:"paradoja",c:"Aparente contradicci√≥n con verdad."},{a:"pleonasmo",c:"Redundancia como ‚Äòsubir arriba‚Äô."},{a:"perenne",c:"Continuo o muy duradero."}],
    Q:[{a:"quimera",c:"Ilusi√≥n imposible; monstruo mitol√≥gico."},{a:"querencia",c:"Apego a un lugar."},{a:"querella",c:"Demanda o disputa judicial."}],
    R:[{a:"resiliencia",c:"Capacidad de sobreponerse a la adversidad."},{a:"refran",c:"Dicho breve popular."},{a:"retorica",c:"Arte de la persuasi√≥n al hablar o escribir."}],
    S:[{a:"sigilo",c:"Reserva y secreto."},{a:"saeta",c:"Canto de Semana Santa; flecha."},{a:"somero",c:"Superficial."}],
    T:[{a:"taciturno",c:"Callado y melanc√≥lico."},{a:"tedio",c:"Aburrimiento profundo."},{a:"tenaz",c:"Persistente."}],
    U:[{a:"utopia",c:"Ideal deseable irrealizable."},{a:"ufano",c:"Orgulloso o satisfecho."},{a:"ubicuo",c:"Presente en muchos lugares (fig.)."}],
    V:[{a:"verosimil",c:"Que parece verdadero."},{a:"voraz",c:"Que come con ansia; muy √°vido."},{a:"vehemente",c:"Apasionado, impetuoso."}],
    X:[{a:"axila",c:"Cavidad bajo el brazo. (contiene X)"},{a:"exiguo",c:"Muy escaso. (contiene X)"},{a:"oxigeno",c:"Gas necesario para la respiraci√≥n. (contiene X)"}],
    Y:[{a:"yodo",c:"Elemento qu√≠mico antis√©ptico."},{a:"yegua",c:"Hembra del caballo."},{a:"yermo",c:"Tierra inculta o despoblada."}],
    Z:[{a:"zigzag",c:"L√≠nea quebrada por tramos alternos."},{a:"zarcillo",c:"Tallo con que se agarran plantas."},{a:"zoquete",c:"Persona torpe."}]
  };

  /* ===== Nombres ===== */
  function getName(s){ return state.names[s] || (s==='A'?'Jugador A':'Jugador B'); }
  function applyNamesUI(){
    $('#nameA').textContent = getName('A');
    $('#nameB').textContent = getName('B');
    $('#turnTag').textContent = 'Turno: ' + getName(state.active);
  }

  /* ===== Dibujo y UI ===== */
  function ringLayout(el,side){
    el.innerHTML='';
    var n=state.rosco[side].length, r=44;
    for(var i=0;i<n;i++){
      var it=state.rosco[side][i], a=(i/n)*Math.PI*2-Math.PI/2, x=50+Math.cos(a)*r, y=50+Math.sin(a)*r;
      var d=document.createElement('div'); d.className='dot'; d.setAttribute('data-letter', it.letter); d.style.left=x+'%'; d.style.top=y+'%';
      if(it.status==='ok') d.className+=' ok'; else if(it.status==='bad') d.className+=' bad';
      if(i===state.idx[side] && state.active===side) d.className+=' active';
      el.appendChild(d);
    }
  }
  function count(s,status){ var arr=state.rosco[s], k=0; for(var i=0;i<arr.length;i++){ if(arr[i].status===status) k++; } return k; }
  function render(){
    ringLayout($('#rA'),'A'); ringLayout($('#rB'),'B');
    $('#aOK').textContent=count('A','ok'); $('#bOK').textContent=count('B','ok');
    $('#aBAD').textContent=count('A','bad'); $('#bBAD').textContent=count('B','bad');
    $('#aPEN').textContent=count('A','pending'); $('#bPEN').textContent=count('B','pending');
    $('#tA').textContent=tfmt(state.time.A); $('#tB').textContent=tfmt(state.time.B);
    document.body.className=(state.view==='focus'?'view-focus ':'view-dual ')+('focus-'+state.active);
    $('#btnPause').textContent=state.paused?'Reanudar':'Pausar';
    $('#btnPauseFab').textContent=state.paused?'‚ñ∂Ô∏è':'‚è∏Ô∏è';
    $('#writeTag').style.display=state.typingHold?'inline-block':'none';
    $('#gameTag').textContent='Juego: '+state.game;
    applyNamesUI();
  }
  function labelFor(L){ if(L==='√ë')return'Contiene e√±e'; if(L==='X')return'Contiene equis'; if(L==='Q')return'Con la cu'; if(L==='Y')return'Con la ye'; return 'Con la '+L.toLowerCase(); }
  function setClue(){
    var s=state.active, i=state.idx[s]; $('#turnTag').textContent='Turno: '+getName(s);
    if(i===-1){ switchTurn(); return; }
    var it=state.rosco[s][i];
    var txt=labelFor(it.letter)+': '+it.clue;
    $('#clue').textContent=txt;
    if(state.tts) speak(txt);
    render();
  }

  function nextPending(side, fromIdx){
    var n=state.rosco[side].length;
    for(var k=1;k<=n;k++){ var j=(fromIdx+k)%n; if(state.rosco[side][j].status==='pending') return j; }
    return -1;
  }

  function startTimers(){
    if(state.timer) clearInterval(state.timer);
    state.timer=setInterval(function(){
      if(!state.running || state.paused || state.typingHold || state.turnBreak) return;
      var s=state.active;
      if(state.time[s]>0){
        state.time[s]-=1; $('#tA').textContent=tfmt(state.time.A); $('#tB').textContent=tfmt(state.time.B);
        if(state.time[s]===0){ switchTurn(); }
      }
      if( (state.time.A===0 && state.time.B===0) || (state.idx.A===-1 && state.idx.B===-1) ){ endGame(); }
    },1000);
  }

  function start(){ if(state.running||state.finished) return;
    state.running=true; state.paused=false; state.turnBreak=false; state.dirty=true;
    $('#btnAnswer').disabled=false; $('#btnPass').disabled=false; $('#btnGiveUp').disabled=false;
    $('#answer').focus(); setClue(); startTimers();
  }

  function pauseToggle(force){ var want=(typeof force==='boolean')?force:!state.paused; state.paused=want;
    $('#ovPause').style.display=state.paused?'grid':'none'; render(); }
  function toggleTypingHold(on){ state.typingHold=(typeof on==='boolean')?on:!state.typingHold; if(state.typingHold) $('#answer').focus(); render(); }

  function switchTurn(){
    var tries=0;
    do{
      state.active=(state.active==='A')?'B':'A';
      var s=state.active;
      if(state.time[s]===0 || state.idx[s]===-1){ tries++; if(tries>2){ endGame(); return; } continue; }
      break;
    }while(true);
    setClue();
  }

  /* Burbuja central con la respuesta correcta */
  function showCenterAnswer(side, answerText){
    var host = (side==='A') ? $('#rA') : $('#rB');
    var prev = host.querySelector('.center-bubble'); if(prev) prev.remove();
    var b = document.createElement('div'); b.className='center-bubble'; b.innerHTML='Era: <b>'+answerText+'</b>';
    host.appendChild(b);
  }
  function clearCenterAnswer(){
    var b1 = $('#rA').querySelector('.center-bubble'); if(b1) b1.remove();
    var b2 = $('#rB').querySelector('.center-bubble'); if(b2) b2.remove();
  }

  function startBreak(kind, opts){
    state.turnBreak=true; render();
    var title=(kind==='pass')?'Pasapalabra':'Fallo';
    $('#brTitle').textContent = title;
    var text='Cambio de turno. Respira‚Ä¶';
    if(kind==='fail' && opts && opts.answer){ text = 'Era: '+opts.answer+' ¬∑ Cambio de turno. Respira‚Ä¶'; }
    $('#brText').textContent = text;
    $('#ovBreak').style.display='grid';
    if(kind==='pass'){ if(!state.tts && state.sounds) sPass(); if(state.tts) speak('¬°Pasapalabra!'); }
    if(kind==='fail'){ if(!state.tts && state.sounds) sFail(); if(state.tts) speak('¬°Fallo!'); }
  }

  function submitAnswer(){
    if(!state.running||state.finished) return;
    var s=state.active, i=state.idx[s]; if(i===-1){ switchTurn(); return; }
    var it=state.rosco[s][i];
    var val=norm($('#answer').value); $('#answer').value='';
    if(state.typingHold) toggleTypingHold(false);
    if(!val){ doPass(); return; }
    var ok=same(norm(it.answer), val);
    it.status = ok?'ok':'bad';
    render();

    if(ok){
      if(state.sounds) sCorrect();
      if(allOk(s)){ endGame({forceWinner:s}); return; }
      var next=nextPending(s,i); state.idx[s]=next; if(next===-1){ switchTurn(); } else { setClue(); }
    }else{
      showCenterAnswer(s, it.answer);
      state.idx[s]=nextPending(s,i);
      startBreak('fail', {answer: it.answer});
    }
  }
  function doPass(){ if(!state.running||state.finished) return; if(state.typingHold) toggleTypingHold(false);
    var s=state.active,i=state.idx[s]; state.idx[s]=nextPending(s,i); startBreak('pass'); }
  function markFail(){ if(!state.running||state.finished) return;
    var s=state.active,i=state.idx[s]; if(i===-1){switchTurn();return;}
    if(state.typingHold) toggleTypingHold(false);
    var it=state.rosco[s][i];
    it.status='bad'; render();
    showCenterAnswer(s, it.answer);
    state.idx[s]=nextPending(s,i);
    startBreak('fail', {answer: it.answer});
  }
  function allOk(side){ var arr=state.rosco[side]; for(var k=0;k<arr.length;k++){ if(arr[k].status!=='ok') return false; } return true; }

  function confetti(){
    var c=document.createElement('canvas'),x=c.getContext('2d');
    c.width=innerWidth;c.height=innerHeight;c.style.cssText='position:fixed;inset:0;z-index:80;pointer-events:none';
    document.body.appendChild(c);
    var colors=['#ffd166','#7c5cff','#1ec28b','#ff5d6c','#66e3ff'];
    var P=Array.from({length:140},function(){return {x:Math.random()*c.width,y:-20-Math.random()*100,r:4+Math.random()*4,c:colors[(Math.random()*colors.length)|0],vx:(Math.random()-.5)*2,vy:2+Math.random()*3,rot:Math.random()*360,vr:(Math.random()*6-3)};});
    var start=performance.now(),T=1800;
    function draw(now){
      x.clearRect(0,0,c.width,c.height);
      for(var i=0;i<P.length;i++){ var p=P[i]; p.vy+=0.03;p.x+=p.vx;p.y+=p.vy;p.rot+=p.vr;
        x.save();x.translate(p.x,p.y);x.rotate(p.rot*Math.PI/180);
        x.fillStyle=p.c;x.fillRect(-p.r,-p.r,p.r*2,p.r*2);x.restore(); }
      if(now-start<T) requestAnimationFrame(draw); else document.body.removeChild(c);
    }
    requestAnimationFrame(draw);
  }

  function endGame(opts){
    state.finished=true; state.running=false; if(state.timer) clearInterval(state.timer);
    var Aok=count('A','ok'), Bok=count('B','ok'); var Abad=count('A','bad'), Bbad=count('B','bad');
    var w=null, detail='';
    if(opts && opts.forceWinner){ w=opts.forceWinner; detail=' ¬∑ Complet√≥ el rosco'; }
    else { if(Aok>Bok) w='A'; else if(Bok>Aok) w='B'; else { if(Abad<Bbad) w='A'; else if(Bbad<Abad) w='B'; else w='empate'; } }
    var R=$('#result'); R.style.display='block';
    if(w==='empate'){
      R.innerHTML='<strong>Empate t√©cnico.</strong> '+getName('A')+' '+Aok+' / '+getName('B')+' '+Bok+' ¬∑ Fallos '+getName('A')+' '+Abad+' / '+getName('B')+' '+Bbad;
    }else{
      var winnerName=getName(w);
      R.innerHTML='<strong>Gana: '+winnerName+'</strong> ¬∑ Aciertos '+getName('A')+' '+Aok+' / '+getName('B')+' '+Bok+' ¬∑ Fallos '+getName('A')+' '+Abad+' / '+getName('B')+' '+Bbad+detail;
      confetti();
      if(state.tts) speak('Gana '+winnerName+'!');
    }
    $('#btnAnswer').disabled=true; $('#btnPass').disabled=true; $('#btnGiveUp').disabled=true;
  }

  /* ===== Generaci√≥n de roscos con semilla (reproducible por Juego) ===== */
  function makeRoscosSeeded(game){
    var base = seedFromGame(game);
    var A=[],B=[];
    for(var li=0;li<LETTERS.length;li++){
      var L=LETTERS[li], pool=BANK[L];
      // rng espec√≠fico por letra para estabilidad
      var rng = mulberry32((base + (li+1)*0x9E3779B1)>>>0);
      var picks = seededPick(pool, 2, rng);
      if(picks.length===1){ picks[1]=picks[0]; }
      if(picks[0]===picks[1]) picks[1]=pool[(pool.indexOf(picks[0])+1)%pool.length];
      A.push({letter:L,clue:picks[0].c,answer:picks[0].a,status:'pending'});
      B.push({letter:L,clue:picks[1].c,answer:picks[1].a,status:'pending'});
    }
    return {A:A,B:B};
  }

  function newGameFromSeed(game){
    var r=makeRoscosSeeded(game);
    state.rosco.A=r.A; state.rosco.B=r.B;
    state.idx.A=0; state.idx.B=0; state.active='A';
    state.finished=false; state.running=false; state.paused=false; state.typingHold=false; state.counting=false; state.turnBreak=false; state.dirty=false;
    clearCenterAnswer();
    $('#ovPause').style.display='none'; $('#ovCount').style.display='none'; $('#ovBreak').style.display='none';
    render(); setClue();
  }

  /* ===== Selector de juegos (1‚Äì10) ===== */
  function buildGamesBar(){
    var bar=$('#gamesBar'); bar.innerHTML='';
    for(var n=1;n<=10;n++){
      var b=document.createElement('button'); b.className='game-btn'; b.textContent=n; b.setAttribute('data-game',n);
      if(n===state.game) b.classList.add('active');
      b.onclick=function(e){
        var g=parseInt(e.currentTarget.getAttribute('data-game'),10);
        if(state.dirty && !confirm('Cambiar al Juego '+g+' reiniciar√° la partida actual. ¬øContinuar?')) return;
        state.game=g; localStorage.setItem('rosco_game', String(g));
        document.querySelectorAll('.game-btn').forEach(function(el){ el.classList.remove('active'); });
        e.currentTarget.classList.add('active');
        $('#gameTag').textContent='Juego: '+g;
        newGameFromSeed(g);
      };
      bar.appendChild(b);
    }
  }

  /* ===== Cuenta atr√°s con voz/beep ===== */
  function startCountdown(then){
    if(state.counting) return; state.counting=true; $('#ovCount').style.display='grid';
    var n=3; $('#countNum').textContent=n;
    if(state.tts) speak(String(n)); else if(state.sounds) tone(660,0.15,'square');
    var id=setInterval(function(){
      n--;
      if(n>0){
        $('#countNum').textContent=n;
        if(state.tts) speak(String(n)); else if(state.sounds) tone(660,0.15,'square');
      }else{
        clearInterval(id); $('#ovCount').style.display='none'; state.counting=false; then();
      }
    },1000);
  }

  /* ===== Ajustes y botones ===== */
  var dlg=$('#dlg');
  function openDialog(){ if(dlg.showModal) dlg.showModal(); else dlg.setAttribute('open',''); }
  function closeDialog(){ if(dlg.close) dlg.close(); else dlg.removeAttribute('open'); }

  function populateSettings(){
    $('#rngTime').value=state.time.A; $('#valTime').textContent=state.time.A+' s';
    $('#chkTTS').checked=state.tts; $('#chkSound').checked=state.sounds;
    $('#nameAInput').value=getName('A'); $('#nameBInput').value=getName('B');
  }

  $('#btnSettings').onclick=function(){ populateSettings(); openDialog(); };
  $('#btnCancel').onclick=function(){ closeDialog(); };
  $('#rngTime').oninput=function(e){ $('#valTime').textContent=e.target.value+' s'; };
  $('#btnApply').onclick=function(){
    var secs=parseInt($('#rngTime').value,10); state.time.A=secs; state.time.B=secs;
    state.tts=$('#chkTTS').checked; state.sounds=$('#chkSound').checked;
    state.names.A = ($('#nameAInput').value || 'Jugador A').trim();
    state.names.B = ($('#nameBInput').value || 'Jugador B').trim();
    localStorage.setItem('rosco_name_A', state.names.A);
    localStorage.setItem('rosco_name_B', state.names.B);
    $('#supportNote').textContent = (!('speechSynthesis' in window) && state.tts) ? 'Tu navegador no soporta voz.' : '';
    render(); closeDialog();
  };
  $('#btnTestVoice').onclick=function(){ unlockAudio(); speak('Prueba de voz. Uno, dos, tres.'); };
  $('#btnTestBeep').onclick=function(){ unlockAudio(); tone(880,0.25,'sine'); };

  var go=function(){ unlockAudio(); startCountdown(start); $('#btnAnswer').disabled=false; $('#btnPass').disabled=false; $('#btnGiveUp').disabled=false; };
  $('#btnStart').onclick=go;
  $('#btnAnswer').onclick=function(){ unlockAudio(); state.dirty=true; submitAnswer(); };
  $('#btnPass').onclick=function(){ unlockAudio(); state.dirty=true; doPass(); };
  $('#btnGiveUp').onclick=function(){ unlockAudio(); state.dirty=true; markFail(); };
  $('#btnPause').onclick=function(){ unlockAudio(); pauseToggle(); };
  $('#btnPauseFab').onclick=function(){ unlockAudio(); pauseToggle(); };
  $('#btnNew').onclick=function(){ if(state.timer) clearInterval(state.timer); state.time.A=145; state.time.B=145; newGameFromSeed(state.game); };
  $('#btnWrite').onclick=function(){ toggleTypingHold(); };
  $('#btnView').onclick=function(){ state.view=(state.view==='focus')?'dual':'focus'; render(); };
  $('#btnResume').onclick=function(){ pauseToggle(false); };
  $('#btnContinue').onclick=function(){ $('#ovBreak').style.display='none'; state.turnBreak=false; clearCenterAnswer(); switchTurn(); render(); };

  document.addEventListener('keydown',function(e){
    if(e.key==='Enter'&&!e.ctrlKey){ unlockAudio(); state.dirty=true; submitAnswer(); }
    if(e.key==='Enter'&&e.ctrlKey){ unlockAudio(); state.dirty=true; doPass(); }
    if(e.key==='Escape') pauseToggle();
  });

  /* ===== Arranque ===== */
  buildGamesBar();
  newGameFromSeed(state.game);

  /* Mostrar errores JS arriba si algo peta */
  window.addEventListener('error',function(e){
    var div=document.createElement('div'); div.style.cssText='position:fixed;left:0;right:0;top:0;background:#400;padding:8px;color:#fff;z-index:9999;font-size:12px';
    div.textContent='Error: '+(e.message||'desconocido'); document.body.appendChild(div); setTimeout(function(){ if(div&&div.parentNode) div.parentNode.removeChild(div); },5000);
  });
})();
</script>
</body>
</html>