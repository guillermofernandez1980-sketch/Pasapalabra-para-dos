<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PASAPALABRA PARA 2</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800;900&display=swap" rel="stylesheet">
<style>
  :root{
    --ink:#fff; --ok:#18d07b; --bad:#ff4d63; --accent:#ffd166;
    --dot:40px; --center-scale:1; --inner-diam:260px; --ctrW:86%;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;color:var(--ink);font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Helvetica Neue",Arial,sans-serif;
       background:linear-gradient(180deg,#1188ff,#0d6af8 55%,#0a56e8)}
  .wrap{max-width:1000px;margin:auto;padding:12px}
  .titleBar{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px}
  h1{font-size:clamp(20px,5vw,28px);margin:0;font-weight:900;letter-spacing:.3px}
  .miniBtns{display:flex;gap:8px}
  .mini{border:1px solid #9ecbff66;background:#0a4ed4;color:#fff;border-radius:12px;padding:8px 10px;font-weight:800;cursor:pointer}

  .panel{background:linear-gradient(180deg,#0e60ff,#0b52dc);border:1px solid #9ecbff55;border-radius:18px;box-shadow:0 10px 26px #053c9b55;padding:10px;margin-top:8px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
  .timer{width:100px;height:100px;border-radius:50px;background:#0b4ed4;border:2px solid #9fd0ff88;display:grid;place-items:center;font-weight:900;font-size:25px}
  .okBub{min-width:40px;height:40px;border-radius:20px;background:var(--ok);color:#022a18;display:grid;place-items:center;font-weight:900;border:2px solid #b8ffe7aa}
  .caps{display:grid;gap:6px}
  .cap{display:flex;align-items:center;gap:8px;background:#0b4ed4;border:1px solid #9fd0ff66;border-radius:12px;padding:7px 10px;font-weight:800}
  .num{width:32px;height:32px;border-radius:16px;display:grid;place-items:center;font-weight:900}
  .num.bad{background:var(--bad)} .num.pen{background:#fff;color:#0c4ab2}
  .turnTag{background:#fff;color:#0b49c6;border-radius:999px;padding:6px 12px;font-weight:900}

  /* Rosco dimensionado por el lado peque√±o del viewport */
  .ringZone{position:relative;width:clamp(260px, min(88vw, 62vh), 560px);aspect-ratio:1/1;margin:12px auto 6px;border-radius:50%;
    background:radial-gradient(circle at 50% 52%, #0b58e3 60%, transparent 61%),
               radial-gradient(circle at 50% 50%, #083fa6 68%, #062f84 70%, transparent 71%);
    box-shadow:0 0 0 2px #8ec2ff66 inset, 0 0 50px #9ed0ff33 inset}
  .ringDots{position:absolute;inset:0}
  .dot{position:absolute;width:var(--dot);height:var(--dot);border-radius:50%;display:grid;place-items:center;font-weight:900;
       color:#0b3a9e;background:#fff;border:3px solid #8ec2ff;transform:translate(-50%,-50%);text-shadow:0 1px 0 #ffffffe0}
  .dot.active{outline:5px solid var(--accent);outline-offset:3px}
  .dot.ok{background:linear-gradient(#71f7c5,#18d07b);border-color:#b8ffe7}
  .dot.bad{background:linear-gradient(#ff95a6,#ff4d63);color:#3c0611;border-color:#ffc7cf}

  /* Centro: columna y centrado */
  .centerStage{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%) scale(var(--center-scale));
    transform-origin:center; display:grid; gap:8px; justify-items:center; text-align:center;
    width:var(--inner-diam); max-width:var(--inner-diam); overflow:hidden;
  }
  .pill{display:inline-block;background:#fff;color:#0b49c6;border-radius:999px;padding:6px 12px;font-weight:900;letter-spacing:.03em;margin:0 auto}
  .field{width:var(--ctrW); margin:0 auto}
  .field input{width:100%;min-width:0;padding:clamp(8px,2vw,11px);border-radius:12px;border:2px solid #8ec2ff99;background:#0a4ed4;color:#fff;font-size:clamp(13px,3vw,16px)}
  .field input::placeholder{color:#e1efffaa}
  .field input.hold{box-shadow:0 0 0 4px #ffd16666}

  .btn{border:0;padding:10px 14px;border-radius:14px;cursor:pointer;font-weight:800}
  .btn-ans{background:var(--ok);color:#052;width:var(--ctrW);margin:0 auto}
  .btn-pass{background:#ffffff;color:#0a4ed4;border:2px solid #8fc2ffaa;font-weight:900;width:var(--ctrW);margin:0 auto}
  .btn-primary{background:#0d7bff;color:#fff;border:1px solid #9ecfff88}
  .btn-ghost{background:#0a4ed4;color:#fff;border:1px solid #9ecfff66}

  .cluePanel{display:block;margin:6px auto 2px;max-width:min(88vw,560px);background:#0b4ed4;border:1px solid #9fd0ff88;border-radius:14px;padding:10px;text-align:center}
  .cluePanel .clueText{font-size:18px;line-height:1.32}

  #feedback{min-height:20px;text-align:center;margin:6px 0 2px}
  .toolbar{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:6px 0 2px}

  /* Overlays */
  .overlay{position:fixed;inset:0;display:none;place-items:center;z-index:50;background:#042a7acc;padding:18px}
  .ovBox{background:#0a4ed4;border:2px solid #9fd0ff;border-radius:18px;padding:16px 18px;text-align:center;max-width:520px}
  .count{font-size:74px;font-weight:900}

  /* Ganador */
  #ovWin{background:transparent;pointer-events:none}
  #confetti{position:fixed;inset:0;pointer-events:none}
  #winMsg{font-size:clamp(20px,6vw,36px);font-weight:900;color:#fff;text-shadow:0 2px 10px #0007}

  /* Modal nombres */
  .formRow{display:grid;gap:8px;margin:8px 0}
  .formRow input{width:100%;padding:10px;border-radius:10px;border:2px solid #9fd0ff;background:#0b58e3;color:#fff;font-weight:800}
</style>
</head>
<body>
  <div class="wrap">
    <div class="titleBar">
      <h1>PASAPALABRA PARA 2</h1>
      <div class="miniBtns">
        <button class="mini" id="btnNames">üë• Nombres</button>
        <button class="mini" id="btnReset">üîÑ Nueva partida</button>
      </div>
    </div>

    <div class="panel">
      <div class="row">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <div class="timer" id="timer">02:30</div>
          <div class="okBub" id="okNow">0</div>
          <span class="turnTag" id="turnTag">Turno: Jugador A</span>
        </div>
        <div class="caps">
          <div class="cap">PALABRAS FALLADAS <span class="num bad" id="badTotal">0</span></div>
          <div class="cap">PALABRAS RESTANTES <span class="num pen" id="penTotal">25</span></div>
        </div>
      </div>

      <div class="ringZone" id="ring">
        <div class="ringDots" id="ringDots"></div>

        <!-- Centro -->
        <div class="centerStage" id="center">
          <div class="pill" id="letterTag">Pulsa EMPEZAR</div>
          <div class="field" id="fieldRow" style="display:none">
            <input id="answer" type="text" placeholder="Escribe tu respuesta‚Ä¶" autocomplete="off" inputmode="latin" />
          </div>
          <button class="btn btn-ans" id="btnAnswer" style="display:none">RESPONDER</button>
          <button class="btn btn-pass" id="btnPassBig" style="display:none">PASAPALABRA</button>
          <button class="btn btn-primary" id="btnStart">EMPEZAR</button>
        </div>
      </div>

      <div class="cluePanel" id="cluePanel"><div class="clueText" id="clueBottom">‚Äî</div></div>

      <div id="feedback"></div>
      <div class="toolbar">
        <button class="btn btn-ghost" id="btnWrite">‚úçÔ∏è Escribir (pausar)</button>
        <button class="btn btn-ghost" id="btnPause">‚è∏Ô∏è Pausa</button>
      </div>
      <div id="result" style="text-align:center;font-weight:800;margin:6px 0 2px"></div>
    </div>
  </div>

  <!-- Overlays -->
  <div class="overlay" id="ovPause"><div class="ovBox"><h3>Pausa</h3><p>Todo detenido.</p><button class="btn btn-primary" id="btnResume">Reanudar</button></div></div>
  <div class="overlay" id="ovCount"><div class="ovBox"><div class="count" id="countNum">3</div><p>Preparados‚Ä¶</p></div></div>
  <div class="overlay" id="ovBreak"><div class="ovBox"><h3 id="brTitle">Cambio de turno</h3><p id="brText">Respira‚Ä¶</p><button class="btn btn-primary" id="btnContinue">Continuar</button></div></div>

  <!-- Correcta al fallar -->
  <div class="overlay" id="ovAnswer"><div class="ovBox"><h3>Respuesta correcta</h3><p id="ansText" style="font-size:22px;font-weight:900;margin:6px 0 0"></p></div></div>

  <!-- Ganador -->
  <div class="overlay" id="ovWin">
    <canvas id="confetti"></canvas>
    <div class="ovBox" style="background:transparent;border:none;box-shadow:none">
      <div style="font-size:64px">üèÖ</div>
      <div id="winMsg">¬°Ganador!</div>
    </div>
  </div>

  <!-- Modal nombres -->
  <div class="overlay" id="ovNames">
    <div class="ovBox" style="max-width:560px">
      <h3>Editar nombres</h3>
      <div class="formRow">
        <label>Jugador A</label>
        <input id="nameA" placeholder="Jugador A" />
      </div>
      <div class="formRow">
        <label>Jugador B</label>
        <input id="nameB" placeholder="Jugador B" />
      </div>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
        <button class="btn btn-primary" id="btnSaveNames">Guardar</button>
        <button class="btn" id="btnCloseNames">Cerrar</button>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const pad2=n=>(n<10?'0':'')+n;
  const norm=s=>(s||'').toLowerCase().normalize('NFD')
                      .replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim();
  const tfmt=sec=>{const m=Math.floor(sec/60),s=Math.floor(sec%60);return pad2(m)+':'+pad2(s);};
  const LETTERS=["A","B","C","D","E","F","G","H","I","J","L","M","N","√ë","O","P","Q","R","S","T","U","V","X","Y","Z"];

  const state={ rosco:{A:[],B:[]}, idx:{A:0,B:0}, active:'A',
    time:{A:150,B:150}, running:false, paused:false, typing:false, turning:false, finished:false,
    tts:true, sounds:true, voice:null, names:{A:'Jugador A', B:'Jugador B'} };

  /* ===== Audio, vibraci√≥n & Voz ===== */
  let ACTX=null, unlocked=false;
  function ctx(){try{const C=window.AudioContext||window.webkitAudioContext;if(!C)return null;
       if(!ACTX) ACTX=new C(); if(ACTX.state==='suspended') ACTX.resume(); return ACTX;}catch(e){return null}}
  function unlock(){ if(unlocked) return; const c=ctx(); if(!c) return;
    try{const o=c.createOscillator(),g=c.createGain();g.gain.value=0;o.connect(g);g.connect(c.destination);
      o.start();o.stop(c.currentTime+0.01);unlocked=true;}catch(e){} }
  ['touchstart','mousedown'].forEach(ev=>document.addEventListener(ev,unlock,{once:true,passive:true}));
  const tone=(f,d,t)=>{ if(!state.sounds) return; const c=ctx(); if(!c) return;
    const o=c.createOscillator(),g=c.createGain(); o.type=t||'sine'; o.frequency.value=f; g.gain.value=0.0001;
    o.connect(g); g.connect(c.destination);
    const t0=c.currentTime; g.gain.exponentialRampToValueAtTime(0.18,t0+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,t0+d); o.start(t0); o.stop(t0+d+0.02);
  };
  const vib = pat => { try{ if(navigator.vibrate) navigator.vibrate(pat);}catch(e){} };
  const sOK =()=>{tone(1046,0.18,'triangle'); vib(80);};
  const sBAD=()=>{tone(196,0.32,'sawtooth'); vib([120,60,80]);};
  const sPASS=()=>{tone(660,0.18,'square'); vib(60);};
  function pickVoice(){if(!('speechSynthesis'in window))return;
    const vs=speechSynthesis.getVoices();
    const es=vs.filter(v=>v.lang&&v.lang.toLowerCase().indexOf('es')===0);
    state.voice=es.find(v=>/es[-_]es/i.test(v.lang))||es[0]||null;}
  if('speechSynthesis'in window){speechSynthesis.onvoiceschanged=pickVoice;pickVoice();}
  function speak(t){
    try{
      if(!state.tts||!('speechSynthesis'in window))return;
      if(state.paused||state.turning||state.finished)return;
      const u=new SpeechSynthesisUtterance(t); u.lang='es-ES'; if(state.voice)u.voice=state.voice;
      speechSynthesis.cancel(); speechSynthesis.speak(u);
    }catch(e){}
  }

  /* ===== Definiciones NUEVAS (50) ===== */
  const BANK_A={
    A:{a:"alboroto",c:"Ruido y desorden provocados por una agitaci√≥n o disputa."},
    B:{a:"branquia",c:"√ìrgano respiratorio de peces y algunos invertebrados."},
    C:{a:"cicerone",c:"Gu√≠a que explica a los visitantes lo notable de un lugar."},
    D:{a:"dorsal",c:"Relativo a la espalda o parte posterior de algo."},
    E:{a:"equinoccio",c:"Momento del a√±o en que el d√≠a y la noche tienen igual duraci√≥n."},
    F:{a:"frugal",c:"Sencillo y de poco gasto o cosa parca en comer y vivir."},
    G:{a:"glaciar",c:"Masa de hielo que se desliza lentamente por una pendiente."},
    H:{a:"horizonte",c:"L√≠nea aparente donde parecen juntarse cielo y tierra."},
    I:{a:"incipiente",c:"Que est√° empezando o dando los primeros pasos."},
    J:{a:"jornada",c:"D√≠a de trabajo o tiempo que dura."},
    L:{a:"lexico",c:"Conjunto de palabras de una lengua o campo."},
    M:{a:"magma",c:"Roca fundida en el interior de la Tierra."},
    N:{a:"nebulosa",c:"Nube interestelar de gas y polvo donde nacen estrellas."},
    "√ë":{a:"arana",c:"Ar√°cnido de ocho patas que teje telas. (contiene e√±e)",alt:["ara√±a"]},
    O:{a:"orografia",c:"Conjunto de montes, valles y relieves de un territorio."},
    P:{a:"paradoja",c:"Proposici√≥n que parece contradictoria pero puede ser verdadera."},
    Q:{a:"quimera",c:"Sue√±o, ilusi√≥n o proyecto irrealizable."},
    R:{a:"retorica",c:"Arte de hablar y escribir con correcci√≥n y elegancia."},
    S:{a:"sinergia",c:"Acci√≥n conjunta que produce un efecto mayor que la suma de las partes."},
    T:{a:"troposfera",c:"Capa m√°s baja de la atm√≥sfera terrestre."},
    U:{a:"ultravioleta",c:"Radiaci√≥n electromagn√©tica de menor longitud de onda que la violeta."},
    V:{a:"vendimia",c:"√âpoca o acci√≥n de recoger la uva."},
    X:{a:"xilofono",c:"Instrumento musical de l√°minas afinadas. (contiene equis)",alt:["xil√≥fono"]},
    Y:{a:"yodo",c:"Elemento qu√≠mico hal√≥geno de s√≠mbolo I."},
    Z:{a:"zigzag",c:"L√≠nea quebrada con √°ngulos que alternan su direcci√≥n."}
  };
  const BANK_B={
    A:{a:"anagrama",c:"Cambio del orden de las letras de una palabra para formar otra."},
    B:{a:"bitacora",c:"Cuaderno de navegaci√≥n; hoy, diario de actividades.",alt:["bit√°cora"]},
    C:{a:"cataclismo",c:"Desastre o perturbaci√≥n de gran alcance."},
    D:{a:"dicotomia",c:"Divisi√≥n de un concepto en dos partes opuestas.",alt:["dicotom√≠a"]},
    E:{a:"efimero",c:"Que dura muy poco tiempo.",alt:["ef√≠mero"]},
    F:{a:"fecundo",c:"Que produce o puede producir en abundancia."},
    G:{a:"gramatica",c:"Estudio de las reglas de una lengua.",alt:["gram√°tica"]},
    H:{a:"heraldo",c:"Mensajero que anuncia o trae noticias importantes."},
    I:{a:"inercia",c:"Tendencia a mantener el estado de reposo o movimiento."},
    J:{a:"jadeo",c:"Respiraci√≥n agitada y entrecortada."},
    L:{a:"linaje",c:"Ascendencia o descendencia de una familia."},
    M:{a:"mecenas",c:"Persona que protege y financia a artistas o cient√≠ficos."},
    N:{a:"nadir",c:"Punto del cielo opuesto al cenit, bajo el observador."},
    "√ë":{a:"campina",c:"Terreno llano y extenso de cultivos. (contiene e√±e)",alt:["campi√±a"]},
    O:{a:"orbita",c:"Trayectoria que sigue un cuerpo alrededor de otro.",alt:["√≥rbita"]},
    P:{a:"palindromo",c:"Palabra o frase que se lee igual en ambos sentidos.",alt:["pal√≠ndromo"]},
    Q:{a:"quorum",c:"N√∫mero m√≠nimo de asistentes para deliberar v√°lidamente.",alt:["qu√≥rum"]},
    R:{a:"resarcir",c:"Indemnizar o compensar un da√±o."},
    S:{a:"silente",c:"Que guarda silencio; callado."},
    T:{a:"tenacidad",c:"Firmeza y constancia para alcanzar un fin."},
    U:{a:"unguento",c:"Preparado espeso que se aplica sobre la piel.",alt:["ung√ºento"]},
    V:{a:"verosimil",c:"Que parece verdadero o cre√≠ble.",alt:["veros√≠mil"]},
    X:{a:"axila",c:"Parte del cuerpo situada bajo la uni√≥n del brazo con el tronco. (contiene equis)"},
    Y:{a:"yacimiento",c:"Lugar donde se encuentran restos arqueol√≥gicos o minerales."},
    Z:{a:"zarzamora",c:"Planta espinosa que da moras; tambi√©n su fruto."}
  };

  const clueFor=(L,def)=> L==='√ë' ? 'Contiene e√±e: '+def
                     : L==='X' ? 'Contiene equis: '+def
                     : L==='Q' ? 'Con la cu: '+def
                     : L==='Y' ? 'Con la ye: '+def
                     : 'Empieza por '+L.toLowerCase()+': '+def;

  /* ===== Dibujo & encaje ===== */
  function drawRing(){
    const host=$('#ringDots'); host.innerHTML='';
    const arr=state.rosco[state.active], n=arr.length, R=47;
    for(let i=0;i<n;i++){
      const it=arr[i], ang=(i/n)*Math.PI*2 - Math.PI/2;
      const x=50+Math.cos(ang)*R, y=50+Math.sin(ang)*R;
      const d=document.createElement('div'); d.className='dot';
      if(i===state.idx[state.active]) d.classList.add('active');
      if(it.status==='ok') d.classList.add('ok'); if(it.status==='bad') d.classList.add('bad');
      d.style.left=x+'%'; d.style.top=y+'%'; d.textContent=it.letter; host.appendChild(d);
    }
  }
  function fitDots(){
    const ring=$('#ring'), w=ring.clientWidth;
    const R = w*0.448, per=2*Math.PI*R;
    const dot=Math.max(16, Math.min(50, Math.floor((per/LETTERS.length)*0.78)));
    ring.style.setProperty('--dot', dot+'px');
    const inner=2*(R - dot*0.5 - 22);
    ring.style.setProperty('--inner-diam', Math.max(168, inner)+'px');
  }
  function scaleCenter(){
    const inner=parseFloat(getComputedStyle($('#ring')).getPropertyValue('--inner-diam'))||240;
    const center=$('#center'); center.style.setProperty('--center-scale','1');
    const w=center.scrollWidth, h=center.scrollHeight;
    const SAFE=0.92; const scale=Math.min(1, SAFE*inner/(Math.max(w,h)+2));
    center.style.setProperty('--center-scale', String(scale));
  }
  function redraw(){ fitDots(); drawRing(); scaleCenter(); setTimeout(scaleCenter,120); }

  const count=(side,st)=>state.rosco[side].reduce((k,it)=>k+(it.status===st),0);
  const sideFinished=side=>count(side,'pending')===0;
  const otherOf=s=> (s==='A'?'B':'A');
  const otherCanPlay=s=> (state.time[otherOf(s)]>0) && !sideFinished(otherOf(s));

  function updateStats(){
    $('#okNow').textContent=count(state.active,'ok');
    $('#badTotal').textContent=count('A','bad')+count('B','bad');
    $('#penTotal').textContent=count(state.active,'pending');
    $('#turnTag').textContent='Turno: '+state.names[state.active];
  }
  function render(){ $('#timer').textContent=tfmt(state.time[state.active]); drawRing(); updateStats(); }

  /* ===== Juego ===== */
  let timer=null;

  function setClue(){
    if(state.finished) return;
    const s=state.active, i=state.idx[s]; if(i===-1){changeTurn();return;}
    const it=state.rosco[s][i];
    $('#letterTag').textContent='Letra '+it.letter;
    $('#clueBottom').textContent=it.clue; speak(it.clue);
    render(); redraw();
  }

  function nextPending(side,from){
    const n=state.rosco[side].length;
    for(let k=1;k<=n;k++){const j=(from+k)%n; if(state.rosco[side][j].status==='pending') return j;}
    return -1;
  }

  function hardStop(){
    try{ if('speechSynthesis'in window) speechSynthesis.cancel(); }catch(e){}
    state.running=false;
  }

  function startTimers(){
    if(timer) clearInterval(timer);
    timer=setInterval(()=>{
      if(!state.running||state.paused||state.typing||state.turning||state.finished) return;
      const s=state.active;
      if(state.time[s]>0) state.time[s]-=1;
      $('#timer').textContent=tfmt(state.time[s]);

      if(state.time[s]===0){
        // Si el otro no puede jugar, el juego termina YA.
        if(!otherCanPlay(s)){
          hardStop(); endGame(); return;
        }
        // Si el otro s√≠ puede jugar, cambio de turno normal.
        changeTurn(); return;
      }

      // Final por doble cero o ambos terminados
      if((state.time.A===0&&state.time.B===0)||(sideFinished('A')&&sideFinished('B'))) { hardStop(); endGame(); return; }
    },1000);
  }

  function startGame(){
    $('#btnStart').style.display='none';
    $('#fieldRow').style.display='block';
    $('#btnAnswer').style.display='inline-block';
    $('#btnPassBig').style.display='inline-block';
    state.running=true; setClue(); startTimers(); $('#answer').focus(); redraw();
  }

  function lev(a,b){const m=a.length,n=b.length,dp=new Array(n+1);for(let j=0;j<=n;j++)dp[j]=j;
    for(let i=1;i<=m;i++){let p=dp[0];dp[0]=i;for(let j=1;j<=n;j++){const t=dp[j];const c=(a[i-1]===b[j-1])?0:1;
      dp[j]=Math.min(dp[j]+1,dp[j-1]+1,p+c);p=t;}}return dp[n];}
  const normAns=s=>norm(s);
  function correct(item,g){const ans=normAns(item.answer); if(g===ans) return true;
    for(const alt of item.alt||[]) if(normAns(alt)===g) return true;
    return (ans.length>=6 && lev(ans,g)<=1);}

  function submit(){
    if(!state.running||state.turning||state.finished) return;
    const s=state.active,i=state.idx[s]; if(i===-1){changeTurn();return;}
    const it=state.rosco[s][i]; const val=norm($('#answer').value); $('#answer').value='';
    if(state.typing) toggleTyping(false);
    if(!val){ pass(); return; }

    if(correct(it,val)){
      it.status='ok'; sOK(); $('#feedback').innerHTML='';
      if(sideFinished(s)){ hardStop(); endGame({forceWinner:s}); return; }
      state.idx[s]=nextPending(s,i); setClue();
    }else{
      it.status='bad'; sBAD(); speak('¬°Fallo!');
      state.idx[s]=nextPending(s,i);
      $('#feedback').innerHTML='Era: <b>'+it.answer+'</b>';

      // Mostrar correcta un momento
      state.turning=true;
      $('#ansText').textContent=it.answer;
      $('#ovAnswer').style.display='grid';

      const solo = !otherCanPlay(s);
      setTimeout(()=>{
        $('#ovAnswer').style.display='none';
        if(state.finished) return;
        if(solo){
          // seguir el mismo jugador sin overlay
          state.turning=false;
          setClue(); render(); redraw();
        }else{
          startBreak('Fallo ¬∑ cambio de turno');
        }
      },1200);
    }
    render(); redraw();
  }

  /* === Pasapalabra con salto suave si solo queda un jugador === */
  function pass(){
    if(!state.running||state.turning||state.finished) return;
    if(state.typing) toggleTyping(false);
    const s=state.active,i=state.idx[s];
    const solo = !otherCanPlay(s);
    const nxt = nextPending(s,i);
    sPASS(); speak('¬°Pasapalabra!');

    if(nxt===-1 && solo){ hardStop(); endGame({forceWinner:s}); return; }
    state.idx[s]=nxt;

    if(solo){
      setClue(); render(); redraw(); // sin cartel
    }else{
      startBreak('Pasapalabra ¬∑ cambio de turno'); render(); redraw();
    }
  }

  function startBreak(title){ $('#brTitle').textContent=title; $('#ovBreak').style.display='grid'; }
  function changeTurn(){
    $('#feedback').innerHTML='';
    state.active=otherOf(state.active);
    state.turning=false;
    speak('Turno de '+state.names[state.active]);
    // Si al cambiar el otro no puede jugar, evaluar final por seguridad
    if(!otherCanPlay(otherOf(state.active)) && state.time[state.active]===0){
      hardStop(); endGame(); return;
    }
    setClue(); render(); redraw();
  }

  function showWin(name){
    $('#winMsg').textContent='¬°Gana '+name+'!';
    $('#ovWin').style.display='grid';
    const cv=$('#confetti'); const dpr=window.devicePixelRatio||1;
    function size(){ cv.width=innerWidth*dpr; cv.height=innerHeight*dpr; cv.style.width='100vw'; cv.style.height='100vh'; }
    size(); const cx=cv.getContext('2d'); cx.scale(dpr,dpr);
    const parts=[]; const COLORS=['#ff5c8a','#ffd166','#9bffb0','#6ecbff','#d3a6ff'];
    for(let i=0;i<180;i++){parts.push({x:Math.random()*innerWidth,y:-20-Math.random()*200,r:4+Math.random()*6,
      vx:-1+Math.random()*2, vy:2+Math.random()*3, rot:Math.random()*Math.PI, vr:-0.05+Math.random()*0.1,
      c:COLORS[i%COLORS.length]});}
    let stop=false;
    (function loop(){
      if(stop) return;
      cx.clearRect(0,0,innerWidth,innerHeight);
      parts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=0.02; p.rot+=p.vr;
        cx.save(); cx.translate(p.x,p.y); cx.rotate(p.rot);
        cx.fillStyle=p.c; cx.fillRect(-p.r,-p.r,p.r*2,p.r*2); cx.restore();
      });
      requestAnimationFrame(loop);
    })();
    setTimeout(()=>{ stop=true; $('#ovWin').style.display='none'; }, 2600);
  }

  function endGame(opts){
    state.finished=true;
    try{ if('speechSynthesis'in window) speechSynthesis.cancel(); }catch(e){}
    if(timer) clearInterval(timer);
    $('#ovBreak').style.display='none';
    $('#ovAnswer').style.display='none';

    const Aok=count('A','ok'), Bok=count('B','ok'), Abad=count('A','bad'), Bbad=count('B','bad');
    let w=null,detail='';
    if(opts&&opts.forceWinner){w=opts.forceWinner; detail=' ¬∑ Complet√≥ su rosco';}
    else{
      if(Aok>Bok) w='A';
      else if(Bok>Aok) w='B';
      else { if(Abad<Bbad) w='A'; else if(Bbad<Abad) w='B'; else w='empate'; }
    }
    const R=$('#result');
    if(w==='empate'){R.textContent='Empate t√©cnico';}
    else{ const nm=state.names[w]; R.innerHTML='Gana: <b>'+nm+'</b>'+detail; speak('Gana '+nm); showWin(nm); }
    updateStats();
  }

  /* ===== UI ===== */
  function toggleTyping(on){state.typing=(typeof on==='boolean')?on:!state.typing;
    if(state.typing) $('#answer').focus(); $('#answer').classList.toggle('hold',state.typing); scaleCenter();}
  function togglePause(on){state.paused=(typeof on==='boolean')?on:!state.paused;
    $('#ovPause').style.display=state.paused?'grid':'none';}
  $('#btnStart').onclick=function(){
    unlock(); if(!state.running){
      $('#ovCount').style.display='grid'; let n=3; $('#countNum').textContent=n; speak('3');
      const id=setInterval(function(){n--; if(n>0){$('#countNum').textContent=n; speak(String(n));}
        else{clearInterval(id); $('#ovCount').style.display='none'; startGame();}},1000);
    }
  };
  $('#btnAnswer').onclick=function(){unlock(); submit();};
  $('#btnPassBig').onclick=function(){unlock(); pass();};
  $('#btnPause').onclick=function(){unlock(); togglePause();};
  $('#btnResume').onclick=function(){togglePause(false);};
  $('#btnContinue').onclick=function(){ $('#ovBreak').style.display='none'; changeTurn(); };
  $('#btnWrite').onclick=function(){ toggleTyping(); };
  document.addEventListener('keydown',function(e){
    if(e.key==='Enter'&&!e.ctrlKey){submit();}
    if(e.key==='Enter'&&e.ctrlKey){pass();}
    if(e.key==='Escape'){togglePause();}
  });

  const fullRedraw=()=>{redraw();};
  window.addEventListener('resize', fullRedraw);
  window.addEventListener('orientationchange', ()=>setTimeout(fullRedraw,250));
  if (window.visualViewport){ ['resize','scroll'].forEach(ev=>visualViewport.addEventListener(ev,()=>setTimeout(fullRedraw,50))); }
  if(window.ResizeObserver){ new ResizeObserver(()=>scaleCenter()).observe($('#center')); }
  if (document.fonts && document.fonts.ready) { document.fonts.ready.then(()=>setTimeout(fullRedraw,50)); }

  /* ===== Nombres (localStorage) ===== */
  const LS_KEY='rosco_names_v38';
  function loadNames(){ try{const raw=localStorage.getItem(LS_KEY); if(!raw) return;
      const obj=JSON.parse(raw); if(obj.A) state.names.A=obj.A; if(obj.B) state.names.B=obj.B; }catch(e){} }
  function saveNames(){ try{localStorage.setItem(LS_KEY, JSON.stringify(state.names));}catch(e){} }
  function openNames(){ $('#nameA').value=state.names.A; $('#nameB').value=state.names.B; $('#ovNames').style.display='grid'; }
  function closeNames(){ $('#ovNames').style.display='none'; }
  $('#btnNames').onclick=openNames;
  $('#btnCloseNames').onclick=closeNames;
  $('#btnSaveNames').onclick=function(){
    state.names.A = ($('#nameA').value||'').trim() || 'Jugador A';
    state.names.B = ($('#nameB').value||'').trim() || 'Jugador B';
    saveNames(); updateStats(); closeNames();
  };
  $('#btnReset').onclick=function(){ newMatch(); };

  /* ===== Nueva partida ===== */
  function buildRoscos(){
    const A=[],B=[];
    Object.keys(BANK_A).forEach(L=>{
      const a=BANK_A[L], b=BANK_B[L];
      A.push({letter:L,clue:clueFor(L,a.c),answer:a.a,alt:a.alt||[],status:'pending'});
      B.push({letter:L,clue:clueFor(L,b.c),answer:b.a,alt:b.alt||[],status:'pending'});
    });
    return {A,B};
  }
  function newMatch(){
    const r=buildRoscos();
    state.rosco.A=r.A; state.rosco.B=r.B; state.idx.A=0; state.idx.B=0; state.active='A';
    state.running=false; state.paused=false; state.typing=false; state.turning=false; state.finished=false;
    $('#result').innerHTML=''; $('#feedback').innerHTML='';
    $('#btnStart').style.display='inline-block'; $('#fieldRow').style.display='none';
    $('#btnAnswer').style.display='none'; $('#btnPassBig').style.display='none'; $('#answer').value='';
    $('#letterTag').textContent='Pulsa EMPEZAR';
    $('#clueBottom').textContent='Mantienes el turno mientras aciertes. Di ‚Äúpasapalabra‚Äù para ceder turno.';
    state.time.A=state.time.B=150; $('#timer').textContent=tfmt(150);
    redraw(); updateStats();
  }

  loadNames();
  newMatch();
})();
</script>
</body>
</html>